var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,d,c){if(b){d=$jscomp.global;a=a.split(".");for(c=0;c<a.length-1;c++){var e=a[c];e in d||(d[e]={});d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,d,c){var b=this.length||0;0>d&&(d=Math.max(0,b+d));if(null==c||c>b)c=b;c=Number(c);0>c&&(c=Math.max(0,b+c));for(d=Number(d||0);d<c;d++)this[d]=a;return this}},"es6","es3");
var roundPoint=function(a,b){b=void 0===b?1E4:b;a[0]=Math.floor(a[0]*b)/b;a[1]=Math.floor(a[1]*b)/b},getNOAAChartsMeta=function(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4===b.readyState)if(200===b.status){for(var d=JSON.parse(b.responseText),c={},e=0;e!=d.length;c={points:c.points},++e){var g=d[e];c.points=[];if(g.poly)g.poly.forEach(function(a){return function(b){a.points.push(ol.proj.fromLonLat([parseFloat(b[1]),parseFloat(b[0])]))}}(c));else{var k=g.lower;c.points.push(ol.proj.fromLonLat([parseFloat(k[0]),
parseFloat(k[1])]));k=g.upper;c.points.push(ol.proj.fromLonLat([parseFloat(k[0]),parseFloat(k[1])]))}c.points.push(c.points[0]);g.poly=new ol.geom.Polygon([c.points])}a(null,d)}else d=Error(b.responseText),d.status=b.status,a(d)};b.open("GET","charts/noaa/");b.send()},getHeight=function(a){return Math.abs(a.upper[1]-a.lower[1])},contains=function(a,b,d){if(ol.extent.containsExtent(a.poly.getExtent(),d)||a.poly.intersectsCoordinate(b))return!0},getCharts=function(a,b,d){for(var c=[],e=0;e!=a.length;++e){var g=
a[e];contains(g,b,d)&&c.push(g)}c.sort(function(a,b){if(a.scale<b.scale)return-1;if(a.scale>b.scale)return 1;a=getHeight(a);b=getHeight(b);return a>b?-1:a<b?1:0});return c},makeLayers=function(a,b,d,c){var e=[];if(0===b.length)return e;for(var g=b[b.length-1].scale,k=null,h={},l=0;l!=b.length;h={layer:h.layer,source:h.source},++l){var f=b[l];f.minRes=k?k.maxRes:d;f.maxRes=Math.floor(f.minRes+(c-d)*f.scale/g);k=b[l];var m=f.sounding?" Soundings in "+f.sounding:"";h.source=new ol.source.XYZ({url:"tiles/noaa/"+
f.ident+"/{z}/{x}/{y}",attributions:f.ident.split("_")[0]+m});h.layer=new ol.layer.Tile({source:h.source,minResolution:f.minRes,maxResolution:f.maxRes,opacity:.8});h.layer.ident=f.ident;h.source.on("tileloaderror",function(b){return function(d){b.layer.errcnt||(b.layer.errcnt=Array(20).fill(0));b.layer.tileCount||(b.layer.tileCount=[]);var c=d.tile.getTileCoord()[0];++b.layer.errcnt[c];b.layer.tileCount[c]||(b.layer.tileCount[c]=0,b.source.getTileGrid().forEachTileCoord(a._view.calculateExtent(),
c,function(){++b.layer.tileCount[c]}));b.layer.errcnt[c]===b.layer.tileCount[c]&&a._view.setZoom(c-1)}}(h));e.push(h.layer)}return e},MapLocation=function(a){roundPoint(a);this._coord=a;this._point=ol.proj.fromLonLat(a)};MapLocation.prototype.equals=function(a){roundPoint(a);return this._coord[0]===a[0]&&this._coord[1]===a[1]};
var Mode={CURRENT_LOCATION:1,INSPECT_LOCATION:2,SHOW_DESTINATION:4},MarineMap=function(a){this._chartsMeta=null;this._defaultZoom=a.defaultZoom||12;this._rotateView=!1;this._mode=Mode.INSPECT_LOCATION;this._needPosUpdate=!0;this._lastInteraction=null;this._onLocationUpdate=a.onLocationUpdate;this._onUpdateView=a.onUpdateView;this._view=new ol.View({zoom:this._defaultZoom,minZoom:3,maxZoom:18,enableRotation:!1,center:this._location?this._location._point:null});this._view.on("change:center",this._updateView.bind(this));
this._map=new ol.Map({target:a.target,layers:[this._baseLayer()],view:this._view,controls:ol.control.defaults({rotate:!1,attributionOptions:{collapsible:!1}}).extend(a.controls)});this._map.on("pointerdrag",this._updateInteraction.bind(this));this._map.on("pointermove",this._updateInteraction.bind(this));new ol.Graticule({showLabels:!0,map:this._map})};MarineMap.prototype._baseLayer=function(){return new ol.layer.Tile({source:new ol.source.XYZ({url:"tiles/wikimedia/osm-intl/{z}/{x}/{y}"})})};
MarineMap.prototype._updateInteraction=function(){this._lastInteraction=new Date};MarineMap.prototype._isLastCenterVisible=function(a){return this._lastCenter&&ol.extent.containsCoordinate(a,this._lastCenter)};MarineMap.prototype._finishLayers=function(){this._updating=!1;this._locationUpdate&&(this._locationUpdate=!1,this._onLocationUpdate&&this._onLocationUpdate(this._location._coord));this._onUpdateView&&this._onUpdateView()};
MarineMap.prototype._updateLayers=function(a,b,d){this._isLastCenterVisible(b)||(this._updating=!0,this._lastCenter=a,a=this._view.getMinResolution(),b=this._view.getMaxResolution(),this._useLayers(makeLayers(this,d,a,b)),this._finishLayers())};
MarineMap.prototype._updateView=function(){var a=this._view.calculateExtent();if(!this._isLastCenterVisible(a)){var b=this._view.getCenter();if(this._chartsMeta){var d=getCharts(this._chartsMeta,b,a);this._updateLayers(b,a,d)}else this._metaRequested||(this._metaRequested=!0,getNOAAChartsMeta(function(c,d){this._metaRequested=!1;if(c)throw c;this._chartsMeta=d;c=getCharts(this._chartsMeta,b,a);this._updateLayers(b,a,c)}.bind(this)))}};
MarineMap.prototype._showLocation=function(a){this._lastInteraction=null;this._mode!=a&&(this._needPosUpdate=!0);this._mode=a;this._locationUpdate=!0;this._view.setCenter(this._location._point);a!=Mode.CURRENT_LOCATION&&this._map.render();return this._location};MarineMap.prototype._removeChartLayers=function(){if(this._charts)for(var a=0;a!=this._charts.length;++a)this._map.removeLayer(this._charts[a])||alert("Layer not found");this._charts=null};
MarineMap.prototype._useLayers=function(a){this._removeChartLayers();this._charts=a;for(a=0;a!=this._charts.length;++a)this._map.addLayer(this._charts[a]);this.updateFeatures()};MarineMap.prototype.updateFeatures=function(a){a&&(this._needPosUpdate=!0);this._updateCourseLayer();this._updatePositionLayer()};
MarineMap.prototype._newCourseLayer=function(){if(!this._destLocation||!this._currentLocation)return null;var a=this._destLocation._point;return new ol.layer.Vector({source:new ol.source.Vector({features:[new ol.Feature({geometry:new ol.geom.LineString([this._currentLocation._point,a])}),new ol.Feature({geometry:new ol.geom.Point(a)})]}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#00D700",width:5}),image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",
src:"images/pointer.png"})})})};MarineMap.prototype._updateCourseLayer=function(){this._course&&this._map.removeLayer(this._course);(this._course=this._newCourseLayer())&&this._map.addLayer(this._course)};MarineMap.prototype._updatePositionLayer=function(){if(this._needPosUpdate)if(this._posMarks&&!this._map.removeLayer(this._posMarks))console.log("_posMarks layer not found");else{if(this._posMarks=this._newPosLayer())this._map.addLayer(this._posMarks),this._needPosUpdate=!1}else this._posMarks.setZIndex(999)};
MarineMap.prototype._rotate=function(){var a=0;this._rotateView?this._view.rotate(2*Math.PI-geolocation.rotation,this._currentLocation._point):a=geolocation.rotation;return a};
MarineMap.prototype._newPosLayer=function(){var a=[];if(this._currentLocation){var b=new ol.Feature({geometry:new ol.geom.Point(this._currentLocation._point)}),d=this._rotate();d=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:"images/compass4.png",rotateWithView:!this._rotateView,rotation:d})});b.setStyle(d);a.push(b)}this._inspectLocation&&(b=new ol.Feature({geometry:new ol.geom.Point(this._inspectLocation._point)}),d=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,
.5],anchorXUnits:"fraction",anchorYUnits:"fraction",src:"images/view.png",rotateWithView:!this._rotateView,rotation:0})}),b.setStyle(d),a.push(b));return 0===a.length?null:new ol.layer.Vector({source:new ol.source.Vector({features:a})})};MarineMap.prototype.showCurrentLocation=function(a){if(a)this._lastInteraction=null;else if(this._lastInteraction&&(new Date).getTime()<this._lastInteraction.getTime()+6E4)return;this._location=this._currentLocation;return this._showLocation(Mode.CURRENT_LOCATION)};
MarineMap.prototype.showDestination=function(){this._location=this._destLocation;return this._showLocation(Mode.SHOW_DESTINATION)};MarineMap.prototype.showInspectLocation=function(){this._rotateView=!1;this._view.setRotation(0);this._location=this._inspectLocation;return this._showLocation(Mode.INSPECT_LOCATION)};MarineMap.prototype.setCurrentLocation=function(a){this._currentLocation&&this._currentLocation.equals(a)||(this._currentLocation=new MapLocation(a),this._needPosUpdate=!0);return this._currentLocation};
MarineMap.prototype.setInspectLocation=function(a){this._inspectLocation&&this._inspectLocation.equals(a)||(this._inspectLocation=new MapLocation(a),this._needPosUpdate=!0);return this._inspectLocation};MarineMap.prototype.setDestination=function(a){a||(a=this._inspectLocation);this._lastInteraction=null;return this._destLocation=a};MarineMap.prototype.removeDestination=function(){this._lastInteraction=this._destLocation=null};
MarineMap.prototype.toggleRotation=function(){return this._rotateView^=1};MarineMap.prototype.addOverlay=function(a){return this._map.addOverlay(a)};MarineMap.prototype.on=function(a,b){return this._map.on(a,b)};MarineMap.prototype.getView=function(){return this._map.getView()};
